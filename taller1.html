<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control de Taller - Mesas y Tiempos</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS (XLSX) for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(135deg,#0f172a 0%, #111827 100%); color: #0f172a; min-height: 100vh; }
    .table-card { transition: transform .18s ease, box-shadow .18s ease; }
    .table-card:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(0,0,0,0.35); }
    .status-dot { width: 10px; height: 10px; border-radius: 9999px; display:inline-block; margin-right:8px; }
    .modal-bg { background: rgba(0,0,0,0.45); }
    /* small tweaks for dark theme cards */
    .card-bg { background: linear-gradient(180deg,#f8fafc 0%, #ffffff 100%); }
  </style>
</head>
<body class="p-6">

  <div class="max-w-7xl mx-auto">

    <!-- Header -->
    <header class="mb-6 text-white">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold">Control de Taller</h1>
          <p class="text-sm text-white/70">Monitoreo de mesas</p>
        </div>
        <div class="text-right">
          <div id="current-time" class="text-sm text-white/80"></div>
          <div class="mt-1 text-xs text-white/60">Estado: <span id="conn-status" class="text-green-300">Conectado</span></div>
        </div>
      </div>
    </header>

    <!-- Controls -->
    <div class="bg-white/5 p-4 rounded-lg mb-6 flex flex-col md:flex-row md:items-center gap-3 justify-between">
      <div class="flex items-center gap-3">
        <input id="search" type="text" placeholder="Buscar mesa, operador o proyecto..." class="px-3 py-2 rounded-lg bg-white/10 text-white placeholder-white/60 focus:outline-none w-72">
        <select id="filter-type" class="px-3 py-2 rounded-lg bg-white/10 text-white">
          <option value="">Mostrar todo</option>
          <option value="trabajo">Mesas de trabajo</option>
          <option value="corte">Mesa de corte</option>
          <option value="torno">Torno/Taladro</option>
        </select>
      </div>

      <div class="flex items-center gap-3">
        <button id="downloadExcelBtn" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg shadow">
          <i class="fa-solid fa-file-excel mr-2"></i> Descargar Excel (día)
        </button>
        <button id="clearLogBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow" title="Limpiar registros del día (no reversible)">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    </div>

    <!-- Mesas Grid -->
    <section id="mesasGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Cards generated by JS -->
    </section>

    <!-- Registro Diario (Tabla) -->
    <section class="bg-white/90 rounded-lg p-4 shadow">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-bold text-slate-800">Registro diario</h2>
        <div class="text-sm text-slate-600">Entradas guardadas: <span id="logCount">0</span></div>
      </div>

      <div class="overflow-x-auto">
        <table id="logTable" class="min-w-full text-sm">
          <thead>
            <tr class="text-left">
              <th class="px-3 py-2">Fecha</th>
              <th class="px-3 py-2">Mesa</th>
              <th class="px-3 py-2">Tipo</th>
              <th class="px-3 py-2">Operador</th>
              <th class="px-3 py-2">Proyecto</th>
              <th class="px-3 py-2">Herramientas</th>
              <th class="px-3 py-2">Inicio</th>
              <th class="px-3 py-2">Fin</th>
              <th class="px-3 py-2">Duración</th>
            </tr>
          </thead>
          <tbody id="logTbody" class="bg-white/90">
            <!-- rows added by JS -->
          </tbody>
        </table>
      </div>
    </section>

    <footer class="mt-6 text-white/60 text-sm">© Sistema Control de Taller • Versión local</footer>
  </div>

  <!-- Modal: Registrar / Editar actividad -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50 modal-bg">
    <div class="bg-white rounded-lg w-full max-w-xl p-6 mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 id="modalTitle" class="text-lg font-bold">Registrar actividad</h3>
        <button id="closeModal" class="text-slate-500 hover:text-slate-700"><i class="fa-solid fa-times"></i></button>
      </div>

      <div class="space-y-3">
        <div>
          <label class="text-sm font-medium">Mesa</label>
          <input id="modalMesa" class="w-full px-3 py-2 border rounded-md" readonly>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm font-medium">Tipo</label>
            <input id="modalTipo" class="w-full px-3 py-2 border rounded-md" readonly>
          </div>
          <div>
            <label class="text-sm font-medium">Operador</label>
            <input id="modalOperador" class="w-full px-3 py-2 border rounded-md" placeholder="Nombre operador">
          </div>
          <div>
            <label class="text-sm font-medium">Proyecto</label>
            <input id="modalProyecto" class="w-full px-3 py-2 border rounded-md" placeholder="Nombre proyecto (opcional)">
          </div>
        </div>

        <div>
          <label class="text-sm font-medium">Herramientas (separadas por coma)</label>
          <input id="modalHerramientas" class="w-full px-3 py-2 border rounded-md" placeholder="Taladro, Llaves, etc.">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-medium">Hora inicio</label>
            <input id="modalInicio" type="datetime-local" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div>
            <label class="text-sm font-medium">Hora fin</label>
            <input id="modalFin" type="datetime-local" class="w-full px-3 py-2 border rounded-md">
          </div>
        </div>

        <div class="flex gap-2 justify-end">
          <button id="saveActivity" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded">Guardar</button>
          <button id="saveStartOnly" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Guardar solo inicio</button>
          <button id="cancelModal" class="px-4 py-2 bg-slate-200 rounded">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Template for mesa card (not rendered directly) -->
  <template id="mesaTemplate">
    <div class="card-bg rounded-xl p-5 table-card">
      <div class="flex items-start justify-between mb-3">
        <div>
          <div class="text-slate-600 text-sm" id="mesaTipoLabel"></div>
          <h3 class="text-xl font-bold" id="mesaTitulo"></h3>
        </div>
        <div class="text-right">
          <div id="mesaStatus" class="text-sm font-semibold"></div>
          <div class="text-xs text-slate-500" id="mesaSince"></div>
        </div>
      </div>

      <div class="mb-3 text-sm text-slate-700" id="mesaDesc">Descripción</div>

      <div class="mb-4">
        <div class="text-xs text-slate-500 mb-2">Herramientas asignadas</div>
        <div id="mesaTools" class="flex flex-wrap gap-2"></div>
      </div>

      <div class="flex gap-2 mt-auto">
        <button class="startBtn flex-1 py-2 rounded-lg bg-emerald-500 text-white">Iniciar</button>
        <button class="stopBtn flex-1 py-2 rounded-lg bg-red-500 text-white">Finalizar</button>
        <button class="editBtn p-2 rounded-lg bg-slate-100 text-slate-700" title="Agregar / editar datos"><i class="fa-solid fa-pen"></i></button>
      </div>
    </div>
  </template>

  <script>
    /***********************
     * Datos iniciales
     ***********************/
    const mesasInit = [
      { id: 'M1', nombre: 'Mesa 1', tipo: 'trabajo', desc: 'Mesa de trabajo general' },
      { id: 'M2', nombre: 'Mesa 2', tipo: 'trabajo', desc: 'Mesa de trabajo general' },
      { id: 'M3', nombre: 'Mesa 3', tipo: 'trabajo', desc: 'Mesa de trabajo general' },
      { id: 'M4', nombre: 'Mesa 4', tipo: 'trabajo', desc: 'Mesa de trabajo general' },
      { id: 'M5', nombre: 'Mesa 5', tipo: 'trabajo', desc: 'Mesa de trabajo general' },
      { id: 'M6', nombre: 'Mesa 6', tipo: 'trabajo', desc: 'Mesa de trabajo general' },
      { id: 'MC', nombre: 'Mesa Corte', tipo: 'corte', desc: 'Mesa para cortes y sierra' },
      { id: 'MT', nombre: 'Torno / Taladro', tipo: 'torno', desc: 'Área de torno o taladro' },
    ];

    // Estado runtime
    const mesas = {};       // estados por mesa (ocupada/inicio/horaInicio)
    const registros = [];   // registros diarios (para exportar)
    let selectedMesaForModal = null;

    /***********************
     * Utilidades tiempo
     ***********************/
    function nowISOShort() {
      // returns local datetime for input type datetime-local: YYYY-MM-DDTHH:MM
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function formatDateTimeLocalToReadable(dtLocal) {
      if(!dtLocal) return '';
      const d = new Date(dtLocal);
      if(isNaN(d)) return dtLocal;
      return d.toLocaleString('es-ES', { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }

    function durationBetween(startISO, endISO) {
      if(!startISO) return '';
      const s = new Date(startISO);
      const e = endISO ? new Date(endISO) : new Date();
      const diffMs = e - s;
      if(diffMs <= 0) return '0m';
      const mins = Math.floor(diffMs / 60000);
      if(mins < 60) return mins + 'm';
      const hrs = Math.floor(mins/60);
      const rem = mins % 60;
      return `${hrs}h ${rem}m`;
    }

    /***********************
     * Renderizado de tarjetas
     ***********************/
    const grid = document.getElementById('mesasGrid');
    const template = document.getElementById('mesaTemplate');

    function renderMesas(filter = '', search = '') {
      grid.innerHTML = '';
      const q = search.trim().toLowerCase();
      mesasInit.forEach(m => {
        if(filter && m.tipo !== filter) return;
        if(q) {
          const hay = [m.nombre, m.desc, m.tipo].join(' ').toLowerCase();
          if(!hay.includes(q)) return;
        }

        const clone = template.content.cloneNode(true);
        const card = clone.querySelector('.table-card');
        clone.querySelector('#mesaTitulo').textContent = m.nombre;
        clone.querySelector('#mesaTipoLabel').textContent = m.tipo === 'corte' ? 'Corte' : (m.tipo === 'torno' ? 'Torno/Taladro' : 'Trabajo');
        clone.querySelector('#mesaDesc').textContent = m.desc;

        // status area
        const statusEl = clone.querySelector('#mesaStatus');
        const sinceEl = clone.querySelector('#mesaSince');

        const state = mesas[m.id] || { ocupada: false, inicio: null, operador: '', proyecto: '', herramientas: [] };
        if(state.ocupada) {
          statusEl.innerHTML = `<span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-2"></span> Ocupada`;
          sinceEl.textContent = 'Inicio: ' + formatDateTimeLocalToReadable(state.inicio);
        } else {
          statusEl.innerHTML = `<span class="inline-block w-3 h-3 rounded-full bg-emerald-500 mr-2"></span> Disponible`;
          sinceEl.textContent = '';
        }

        // tools
        const toolsContainer = clone.querySelector('#mesaTools');
        toolsContainer.innerHTML = '';
        (state.herramientas || []).forEach(t => {
          const pill = document.createElement('div');
          pill.className = 'px-2 py-1 bg-white/70 rounded text-xs border';
          pill.textContent = t;
          toolsContainer.appendChild(pill);
        });

        // buttons
        const startBtn = clone.querySelector('.startBtn');
        const stopBtn = clone.querySelector('.stopBtn');
        const editBtn = clone.querySelector('.editBtn');

        startBtn.addEventListener('click', ()=> handleStart(m.id));
        stopBtn.addEventListener('click', ()=> handleStop(m.id));
        editBtn.addEventListener('click', ()=> openModalForMesa(m.id));

        grid.appendChild(clone);
      });
    }

    /***********************
     * Acciones Start / Stop
     ***********************/
    function handleStart(mesaId) {
      const m = mesas[mesaId] || {};
      if(m.ocupada) {
        alert('La mesa ya está ocupada. Si deseas actualizar el inicio o crear un nuevo registro usa "Editar".');
        return;
      }
      // abrir modal con inicio automático al momento actual
      selectedMesaForModal = mesaId;
      openModalPrefillStart(mesaId);
    }

    function handleStop(mesaId) {
      const m = mesas[mesaId];
      if(!m || !m.ocupada) {
        alert('La mesa no está en un trabajo activo.');
        return;
      }
      // Abrir modal para completar fin y guardar registro
      selectedMesaForModal = mesaId;
      openModalPrefillStop(mesaId);
    }

    /***********************
     * Modal operations
     ***********************/
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMesa = document.getElementById('modalMesa');
    const modalTipo = document.getElementById('modalTipo');
    const modalOperador = document.getElementById('modalOperador');
    const modalProyecto = document.getElementById('modalProyecto');
    const modalHerramientas = document.getElementById('modalHerramientas');
    const modalInicio = document.getElementById('modalInicio');
    const modalFin = document.getElementById('modalFin');

    function openModalForMesa(mesaId) {
      selectedMesaForModal = mesaId;
      const info = mesasInit.find(x=>x.id===mesaId);
      const state = mesas[mesaId] || { ocupada: false, inicio: null, operador: '', proyecto: '', herramientas: [] };
      modalTitle.textContent = `Editar / Registrar - ${info.nombre}`;
      modalMesa.value = info.nombre;
      modalTipo.value = info.tipo;
      modalOperador.value = state.operador || '';
      modalProyecto.value = state.proyecto || '';
      modalHerramientas.value = (state.herramientas || []).join(', ');
      modalInicio.value = state.inicio ? (new Date(state.inicio)).toISOString().slice(0,16) : '';
      modalFin.value = ''; // por defecto vacío para editar fin o dejar en blanco
      showModal();
    }

    function openModalPrefillStart(mesaId) {
      selectedMesaForModal = mesaId;
      const info = mesasInit.find(x=>x.id===mesaId);
      const now = nowISOShort();
      modalTitle.textContent = `Iniciar trabajo - ${info.nombre}`;
      modalMesa.value = info.nombre;
      modalTipo.value = info.tipo;
      modalOperador.value = '';
      modalProyecto.value = '';
      modalHerramientas.value = '';
      modalInicio.value = now;
      modalFin.value = '';
      showModal();
    }

    function openModalPrefillStop(mesaId) {
      selectedMesaForModal = mesaId;
      const info = mesasInit.find(x=>x.id===mesaId);
      const state = mesas[mesaId];
      if(!state || !state.inicio) {
        alert('No hay inicio registrado para esta mesa.');
        return;
      }
      modalTitle.textContent = `Finalizar trabajo - ${info.nombre}`;
      modalMesa.value = info.nombre;
      modalTipo.value = info.tipo;
      modalOperador.value = state.operador || '';
      modalProyecto.value = state.proyecto || '';
      modalHerramientas.value = (state.herramientas || []).join(', ');
      modalInicio.value = (new Date(state.inicio)).toISOString().slice(0,16);
      modalFin.value = nowISOShort();
      showModal();
    }

    function showModal() {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function hideModal() {
      modal.classList.remove('flex');
      modal.classList.add('hidden');
      selectedMesaForModal = null;
    }

    document.getElementById('closeModal').addEventListener('click', hideModal);
    document.getElementById('cancelModal').addEventListener('click', hideModal);

    // Guardar: crea registro completo (inicio + fin), también marca mesa como libre
    document.getElementById('saveActivity').addEventListener('click', ()=> {
      const mesaId = selectedMesaForModal;
      if(!mesaId) return hideModal();

      const operador = modalOperador.value.trim();
      const proyecto = modalProyecto.value.trim();
      const herramientas = modalHerramientas.value.split(',').map(s=>s.trim()).filter(Boolean);
      const inicioVal = modalInicio.value;
      const finVal = modalFin.value;

      if(!inicioVal) { alert('Debes indicar hora de inicio'); return; }

      // Crear registro
      const registro = {
        fecha: (new Date()).toLocaleDateString('es-ES'),
        mesaId,
        mesaNombre: mesasInit.find(x=>x.id===mesaId).nombre,
        tipo: modalTipo.value,
        operador: operador || '—',
        proyecto: proyecto || '—',
        herramientas: herramientas.join(', '),
        inicio: inicioVal,
        fin: finVal || '',
        duracion: finVal ? durationBetween(inicioVal, finVal) : durationBetween(inicioVal, null)
      };
      // Si fin está vacío => todavía en curso; guardamos registro parcial y también actualizamos estado como ocupado
      registros.push(registro);
      updateLogTable();

      // actualizar estado mesa
      if(finVal) {
        // finalizamos: mesa libre
        mesas[mesaId] = { ocupada: false, inicio: null, operador: '', proyecto: '', herramientas: [] };
      } else {
        // inicio: marcamos ocupada con datos
        mesas[mesaId] = { ocupada: true, inicio: inicioVal, operador, proyecto, herramientas };
      }

      renderMesas(document.getElementById('filter-type').value, document.getElementById('search').value);
      hideModal();
    });

    // Guardar solo inicio (poner mesa en ocupada)
    document.getElementById('saveStartOnly').addEventListener('click', ()=> {
      const mesaId = selectedMesaForModal;
      if(!mesaId) return hideModal();
      const operador = modalOperador.value.trim();
      const proyecto = modalProyecto.value.trim();
      const herramientas = modalHerramientas.value.split(',').map(s=>s.trim()).filter(Boolean);
      const inicioVal = modalInicio.value;
      if(!inicioVal) { alert('Debes indicar hora de inicio'); return; }

      // actualizar estado mesa a ocupada
      mesas[mesaId] = { ocupada: true, inicio: inicioVal, operador, proyecto, herramientas };
      // agregar registro parcial (sin fin)
      registros.push({
        fecha: (new Date()).toLocaleDateString('es-ES'),
        mesaId,
        mesaNombre: mesasInit.find(x=>x.id===mesaId).nombre,
        tipo: modalTipo.value,
        operador: operador || '—',
        proyecto: proyecto || '—',
        herramientas: herramientas.join(', '),
        inicio: inicioVal,
        fin: '',
        duracion: ''
      });

      updateLogTable();
      renderMesas(document.getElementById('filter-type').value, document.getElementById('search').value);
      hideModal();
    });

    /***********************
     * Tabla de registros (UI)
     ***********************/
    const logTbody = document.getElementById('logTbody');
    const logCount = document.getElementById('logCount');

    function updateLogTable() {
      logTbody.innerHTML = '';
      registros.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 border-b">${r.fecha}</td>
          <td class="px-3 py-2 border-b">${r.mesaNombre}</td>
          <td class="px-3 py-2 border-b">${r.tipo}</td>
          <td class="px-3 py-2 border-b">${r.operador}</td>
          <td class="px-3 py-2 border-b">${r.proyecto}</td>
          <td class="px-3 py-2 border-b">${r.herramientas}</td>
          <td class="px-3 py-2 border-b">${formatDateTimeLocalToReadable(r.inicio)}</td>
          <td class="px-3 py-2 border-b">${r.fin ? formatDateTimeLocalToReadable(r.fin) : ''}</td>
          <td class="px-3 py-2 border-b">${r.duracion || (r.inicio ? durationBetween(r.inicio, r.fin) : '')}</td>
        `;
        logTbody.appendChild(tr);
      });
      logCount.textContent = registros.length;
    }

    /***********************
     * Export a Excel (SheetJS)
     ***********************/
    document.getElementById('downloadExcelBtn').addEventListener('click', ()=> {
      if(registros.length === 0) {
        alert('No hay registros para exportar hoy.');
        return;
      }

      // construir hoja de datos
      const ws_data = [
        ['Fecha','Mesa','Tipo','Operador','Proyecto','Herramientas','Inicio (local)','Fin (local)','Duración']
      ];
      registros.forEach(r => {
        ws_data.push([
          r.fecha,
          r.mesaNombre,
          r.tipo,
          r.operador,
          r.proyecto,
          r.herramientas,
          formatDateTimeLocalToReadable(r.inicio),
          r.fin ? formatDateTimeLocalToReadable(r.fin) : '',
          r.duracion || (r.inicio ? durationBetween(r.inicio, r.fin) : '')
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, 'RegistroDiario');

      const fileName = `Registro_Taller_${(new Date()).toLocaleDateString('es-ES').replace(/\//g,'-')}.xlsx`;
      XLSX.writeFile(wb, fileName);
    });

    /***********************
     * Cleaning logs
     ***********************/
    document.getElementById('clearLogBtn').addEventListener('click', ()=> {
      if(!confirm('¿Borrar todos los registros del día? Esta acción no se puede deshacer.')) return;
      registros.length = 0;
      // liberar todas las mesas
      Object.keys(mesas).forEach(k => mesas[k] = { ocupada: false, inicio: null, operador: '', proyecto: '', herramientas: [] });
      updateLogTable();
      renderMesas(document.getElementById('filter-type').value, document.getElementById('search').value);
    });

    /***********************
     * Buscador / filtro
     ***********************/
    document.getElementById('filter-type').addEventListener('change', (e)=> renderMesas(e.target.value, document.getElementById('search').value));
    document.getElementById('search').addEventListener('input', (e)=> renderMesas(document.getElementById('filter-type').value, e.target.value));

    /***********************
     * Inicialización UI
     ***********************/
    function init() {
      // init mesas state
      mesasInit.forEach(m => mesas[m.id] = { ocupada: false, inicio: null, operador: '', proyecto: '', herramientas: [] });

      renderMesas();
      updateLogTable();

      // actualizar reloj
      setInterval(()=> {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleString('es-ES', { weekday:'long', day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
      }, 1000);
    }

    init();

    // cerrar modal al hacer click fuera del contenido
    modal.addEventListener('click', (e)=> {
      if(e.target === modal) hideModal();
    });

    // Prevent accidental form submission on Enter in modal inputs
    Array.from(modal.querySelectorAll('input')).forEach(inp => {
      inp.addEventListener('keydown', (ev) => {
        if(ev.key === 'Enter') ev.preventDefault();
      });
    });

  </script>
</body>
</html>
